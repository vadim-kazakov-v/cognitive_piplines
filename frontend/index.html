<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Cognitive Pipelines UI</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="lib/litegraph.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <style>
    html, body {
      height: 100%;
      margin: 0;
      color: #eee;
      background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
    }
    body {
      display: flex;
      overflow: hidden;
      font-family: sans-serif;
    }
    .glass {
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 4px 30px rgba(0,0,0,0.1);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
    }
    #sidebar {
      width: 220px;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-right: 1px solid rgba(255,255,255,0.2);
    }
    #sidebar button,
    #sidebar input,
    #layout-mode {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      color: #fff;
      padding: 6px 8px;
    }
    #sidebar button {
      cursor: pointer;
      text-align: left;
    }
    #sidebar button:hover {
      background: rgba(255,255,255,0.25);
    }
    #sidebar h3 {
      margin: 8px 0 4px;
      font-size: 14px;
    }
    #main {
      flex: 1;
      display: flex;
    }
    #graph {
      flex: 1;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="sidebar" class="glass">
    <button id="run-btn">Run</button>
    <button id="stop-btn">Stop</button>
    <button id="save-flow">Save Flow</button>
    <button id="load-flow">Load Flow</button>
    <select id="layout-mode">
      <option value="horizontal">Horizontal</option>
      <option value="vertical">Vertical</option>
    </select>
    <button id="layout-btn">Auto Layout</button>
    <input id="file-input" type="file" accept="application/json" style="display:none" />
    <input id="node-search" placeholder="Search nodes" />
    <div id="node-list"></div>
  </div>
  <div id="main" class="glass">
    <canvas id="graph"></canvas>
  </div>
  <script src="lib/litegraph.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
  <script>
    // Highlight.js may fail to load (e.g. offline) which would previously
    // cause a ReferenceError and stop the rest of the script from running.
    // Guard the call so the UI continues to work even without syntax
    // highlighting.
    if (window.hljs) {
      hljs.highlightAll();
    }
    const graph = new LGraph();
    const canvas = new LGraphCanvas("#graph", graph);
    LiteGraph.NODE_DEFAULT_BGCOLOR = "rgba(255,255,255,0.15)";
    LiteGraph.NODE_DEFAULT_COLOR = "#88a";
    LiteGraph.NODE_TITLE_COLOR = "#fff";
    canvas.allow_interaction = canvas.allow_dragcanvas = canvas.allow_dragnodes = true;
    canvas.canvas.addEventListener('dblclick', e => { canvas.adjustMouseEvent(e); canvas.showSearchBox(e); });

    function resizeCanvas() {
      const rect = document.getElementById('main').getBoundingClientRect();
      canvas.resize(rect.width, rect.height);
      canvas.setZoom(1, [rect.width / 2, rect.height / 2]);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const groups = {};
    function registerNode(path, nodeClass) {
      LiteGraph.registerNodeType(path, nodeClass);
      const [group, name] = path.split('/');
      let container = groups[group];
      if (!container) {
        container = document.createElement('div');
        const header = document.createElement('h3');
        header.textContent = group;
        const list = document.createElement('div');
        container.appendChild(header);
        container.appendChild(list);
        document.getElementById('node-list').appendChild(container);
        container.list = list;
        groups[group] = container;
      }
      const btn = document.createElement('button');
      btn.dataset.node = path;
      btn.textContent = `${nodeClass.icon || ''} ${nodeClass.title || name}`;
      container.list.appendChild(btn);
    }

    let lastNode = null;
    document.getElementById('node-list').addEventListener('click', e => {
      if (!e.target.dataset.node) return;
      const node = LiteGraph.createNode(e.target.dataset.node);
      node.pos = [Math.random() * 400 + 100, Math.random() * 200 + 100];
      graph.add(node);
      if (lastNode && lastNode.outputs?.length && node.inputs?.length) {
        lastNode.connect(0, node, 0);
      }
      lastNode = node;
    });

    document.getElementById('run-btn').addEventListener('click', () => {
      graph.start();
    });
    document.getElementById('stop-btn').addEventListener('click', () => {
      graph.stop();
    });
    document.getElementById('layout-btn').addEventListener('click', () => {
      const mode = document.getElementById('layout-mode').value;
      graph.arrange(100, mode === 'vertical' ? LiteGraph.VERTICAL_LAYOUT : undefined);
    });
    document.getElementById('save-flow').addEventListener('click', () => {
      const data = JSON.stringify(graph.serialize(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'flow.json';
      a.click();
    });
    document.getElementById('load-flow').addEventListener('click', () => {
      document.getElementById('file-input').click();
    });
    document.getElementById('file-input').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      file.text().then(txt => {
        const data = JSON.parse(txt);
        graph.clear();
        graph.configure(data);
      });
    });

    const search = document.getElementById('node-search');
    search.addEventListener('input', () => {
      const term = search.value.toLowerCase();
      document.querySelectorAll('#node-list button').forEach(btn => {
        btn.style.display = btn.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
    });

    graph.onNodeAdded = node => {
      const origExec = node.onExecute;
      if (origExec) {
        node.onExecute = async function(...args) {
          const prev = this.color;
          this.color = '#6f6';
          this.setDirtyCanvas(true);
          try {
            return await origExec.apply(this, args);
          } finally {
            this.color = prev;
            this.setDirtyCanvas(true);
          }
        };
      }
      if (node.properties) {
        const origDraw = node.onDrawForeground;
        node.onDrawForeground = function(ctx) {
          if (origDraw) origDraw.call(this, ctx);
          let y = 20;
          ctx.fillStyle = '#fff';
          ctx.font = '12px sans-serif';
          for (const key in this.properties) {
            const val = this.properties[key];
            ctx.fillText(`${key}: ${Math.round(val * 1000) / 1000}`, 4, y);
            y += 14;
          }
        };
      }
    };

    function defaultPipeline() {
      const titanic = LiteGraph.createNode('data/titanic');
      titanic.pos = [50, 150];
      const umap = LiteGraph.createNode('ml/umap');
      umap.pos = [250, 150];
      const scatter = LiteGraph.createNode('viz/scatter2d');
      scatter.pos = [450, 150];
      graph.add(titanic);
      graph.add(umap);
      graph.add(scatter);
      titanic.connect(0, umap, 0);
      umap.connect(0, scatter, 0);
    }
  </script>
  <script src="nodes/data.js"></script>
  <script src="nodes/transform.js"></script>
  <script src="nodes/visualize.js"></script>
  <script src="nodes/util.js"></script>
  <script src="nodes/ml.js"></script>
  <script src="nodes/python.js"></script>
  <script>defaultPipeline();</script>
</body>
</html>
